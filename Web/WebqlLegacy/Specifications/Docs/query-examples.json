//*
// compiler syntax.
//*
[
  [
    "source"
  ],
  {
    "$filter": [
      "result",
      "source",
      [
        [
          "user"
        ],
        {
          "$equal": [
            null,
            "user.nickname",
            "jacques"
          ]
        }
      ]
    ],
    "$project": [
      "result",
      "$result",
      [
        [
          "user"
        ],
        {
          "$expr": [
            null,
            [
              {
                "$first": [
                  "firstName",
                  "$user.name.values"
                ]
              },
              {
                "$parse": ["parsedId", "$firstName", "16/02/2000"],
                "$like": [
                  "likeResult",
                  "$firstName",
                  "$parsedId"
                ]
              }
            ]
          ],
          "id": "user.id",
          "nickname": "user.nickname",
          "firstName": "firstName",
          "documents": {
            "cpf": {
              "value": "user.cpf.value",
              "dob": "user.dob"
            },
            "rg": {
              "value": "user.rg.value"
            }
          }
        }
      ]
    ],
    "$select": "result"
  }
]
//*
// document syntax (transpiles to compiler syntax).
//*
{
  "$filter": {
    "id": "...",
    "nickname": "jacques",
    "name": {
      "firstName": {
        "$like": "rodrigo"
      },
      "surnames": {
        "$count": {
          "$gt": 1
        },
        "$first": {
          "$like": "santos"
        }
      }
    }
  }
}

"$and": [
  "out",
  [
    {
      "$like": [
        "var1",
        "$entity.name.firstName",
        "rodrigo"
      ]
    },
    {
      "$and": [
        "var1",
        [
          {
            "$count": [
              "var2",
              "$entity.name.surnames"
            ],
            "$gt": [
              "var3",
              "$var2",
              1
            ]
          },
          {
            "$first": [
              "var2",
              "$entity.name.surnames"
            ],
            "$like": [
              "var3",
              "$var2",
              "santos"
            ]
          }
        ]
      ]
    }
  ]
];

$like: [
  "var",
  "$entity.name.firstName",
  "jacques"
];
$count: [
  "var2",
  "$entity.name.surnames"
];
$gt: [
  "var3",
  "$var2",
  1
];

//*
// V3 ideas (requires a true tokenizer and analysis state machine).
//*

(source) => {

  result = $filter(source, (entity) => {
    $eq(entity.nickname,
    "jacques");
  });

  result = $project(result, (entity) => {
    "id": entity.id;
    "nickname": entity.nickname;
  });

  result = $limit(result,
  50);

  $select(result);
}

(source) => {

  result = $filter(source, (entity) => {   
    $and [     
      $assert(entity.isActive); 
      $greater(entity.age,
      17);
      $like(entity.name,
      "joseph");
      $regexNot("[a-Z]", entity.name.firstName);
    ];
  });

  result = $project(result, (entity) => {
    "nickname": entity.nickname,
    "surnamesCount": $count(entity.name.surnames),
    "identity": {
      "roles": entity.identity.roles,
    }
  });

  result = $offset(result,
  200);
  result = $limit(result,
  50);

  $select(result);
}